name: '[Monitor] BYOVD & EDR Evasion Projects & Updates'
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

      - name: Upload debug files
        if: always() # å³ä½¿å¤±è´¥ä¹Ÿè¿è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: debug-files
          path: |
            api_response.json
            latest_results.json
          retention-days: 1
          
      - name: Fetch latest project updates
        run: |
          QUERY="%22BYOVD%22%20AND%20(kill%20OR%20antiav%20OR%20antiedr)%20in:name,description,readme"
          API_URL="https://api.github.com/search/repositories?q=$QUERY&sort=updated&order=desc&per_page=30"
          echo "è°ƒç”¨API: $API_URL"
          
          # é¦–å…ˆæµ‹è¯•ghå‘½ä»¤æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
          echo "=== æµ‹è¯•ghå‘½ä»¤ ==="
          gh --version
          
          # æµ‹è¯•è®¤è¯æ˜¯å¦æœ‰æ•ˆ
          echo "=== æµ‹è¯•è®¤è¯ ==="
          gh api user --jq .login || echo "è®¤è¯æµ‹è¯•å¤±è´¥"
          
          # ç›´æ¥æ˜¾ç¤ºAPIè°ƒç”¨çš„åŸå§‹å“åº”
          echo "=== ç›´æ¥æ˜¾ç¤ºAPIå“åº” ==="
          gh api "$API_URL" --verbose 2>&1 | head -50
          
          # å°è¯•ä¿å­˜å“åº”
          echo "=== å°è¯•ä¿å­˜å“åº” ==="
          if gh api "$API_URL" > api_response.raw 2>api_error.log; then
            echo "âœ… APIè°ƒç”¨æˆåŠŸ"
            ls -la api_response.raw
            echo "æ–‡ä»¶å†…å®¹å‰200å­—ç¬¦:"
            head -c 200 api_response.raw || true
          else
            echo "âŒ APIè°ƒç”¨å¤±è´¥"
            echo "é”™è¯¯ä¿¡æ¯:"
            cat api_error.log || true
          fi
          
          # æ— è®ºå¦‚ä½•éƒ½å°è¯•ç»§ç»­ï¼Œçœ‹çœ‹èƒ½èµ°åˆ°å“ªä¸€æ­¥
          touch api_response.json
          touch latest_results.json
          touch current_urls.txt
        env:
          GH_FORCE_TTY: 0

      - name: Retrieve previous state
        run: |
          if [ -f previous_results.json ]; then
            cp previous_results.json previous_results_backup.json
            jq -r '.html_url' previous_results.json > previous_urls.txt
          else
            touch previous_urls.txt
            echo "[]" > previous_results_backup.json
          fi

      - name: Identify new and updated projects
        id: check_changes
        run: |
          grep -Fxv -f previous_urls.txt current_urls.txt > new_items.txt || true
          NEW_COUNT=$(wc -l < new_items.txt | tr -d ' ')
          echo "å‘ç° $NEW_COUNT ä¸ªæ–°é¡¹ç›®"

          # åˆ›å»ºPythonè„šæœ¬æ¥æ£€æµ‹æ›´æ–°

          # æ‰§è¡ŒPythonè„šæœ¬
          python3 ./detect_updates.py

          UPDATED_COUNT=$(wc -l < updated_items.txt | tr -d ' ')
          echo "å‘ç° $UPDATED_COUNT ä¸ªé¡¹ç›®æœ‰é‡è¦æ›´æ–°"

          TOTAL_CHANGES=$((NEW_COUNT + UPDATED_COUNT))
          if [ $TOTAL_CHANGES -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "CHANGE_COUNT=$TOTAL_CHANGES" >> $GITHUB_ENV
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "CHANGE_COUNT=0" >> $GITHUB_ENV
          fi

      - name: Generate RSS feed for changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RSS_ITEM_FILE="rss_items.xml"

          if [ -s new_items.txt ]; then
            jq --slurpfile new_urls new_items.txt -r --arg date "$CURRENT_DATE" '
              .[] | select(.html_url as $u | $new_urls[] | index($u)) |
              @html "  <item>\n    <title>ğŸš€ æ–°é¡¹ç›®: \(.full_name)</title>\n    <link>\(.html_url)</link>\n    <description>æ–°å‘ç°çš„BYOVD/EDRå¯¹æŠ—é¡¹ç›®ã€‚æè¿°: \(.description // \"No description\" | @html)</description>\n    <pubDate>\($date)</pubDate>\n    <guid isPermaLink=\"true\">\(.html_url)?new=1</guid>\n  </item>"
            ' latest_results.json > $RSS_ITEM_FILE
          fi

          if [ -s updated_items.txt ]; then
            jq --slurpfile updated_urls updated_items.txt -r --arg date "$CURRENT_DATE" '
              .[] | select(.html_url as $u | $updated_urls[] | index($u)) |
              @html "  <item>\n    <title>ğŸ“¢ æ›´æ–°: \(.full_name)</title>\n    <link>\(.html_url)</link>\n    <description>é¡¹ç›®æœ‰é‡è¦æ›´æ–°ï¼Œå¯èƒ½å‘å¸ƒäº†æ–°ç‰ˆæœ¬æˆ–æ·»åŠ äº†æ–°åŠŸèƒ½ã€‚æè¿°: \(.description // \"No description\" | @html)</description>\n    <pubDate>\($date)</pubDate>\n    <guid isPermaLink=\"true\">\(.html_url)?updated=\(now|floor)</guid>\n  </item>"
            ' latest_results.json >> $RSS_ITEM_FILE
          fi

      - name: Update RSS feed and persist state
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # åˆ›å»ºPythonè„šæœ¬æ¥æ›´æ–°RSS

          python3 ./update_rss.py

          # ä¿å­˜å½“å‰å®Œæ•´çŠ¶æ€ï¼Œç”¨äºä¸‹æ¬¡æ¯”è¾ƒ
          cp latest_results.json previous_results.json
          cp current_urls.txt previous_urls.txt

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add feed.xml previous_results.json previous_urls.txt
          git commit -m "CI: Found ${{ env.CHANGE_COUNT }} changes ($NEW_COUNT new, $UPDATED_COUNT updated)"
          git push

      - name: No changes notification
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          date +"%Y-%m-%d %H:%M:%S - No changes detected" >> monitor.log
          git add monitor.log
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "CI: Monitoring completed, no changes" || exit 0
          git push || exit 0
